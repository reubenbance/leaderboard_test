<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MVM Fundraising Leaderboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #f5f7fa;
      padding: 20px;
    }
    
    .leaderboard-container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }
    
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }
    
    .header h1 {
      font-size: 28px;
      margin-bottom: 8px;
    }
    
    .header p {
      opacity: 0.9;
      font-size: 16px;
    }
    
    .stats-bar {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 20px;
      padding: 20px 30px;
      background: #f8f9fa;
      border-bottom: 1px solid #e9ecef;
    }
    
    .stat {
      text-align: center;
    }
    
    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #667eea;
    }
    
    .stat-label {
      font-size: 12px;
      color: #6c757d;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 4px;
    }
    
    .leaderboard {
      padding: 20px 30px 30px;
    }
    
    .leaderboard-item {
      display: flex;
      align-items: center;
      padding: 16px;
      margin-bottom: 12px;
      background: #f8f9fa;
      border-radius: 12px;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .leaderboard-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .rank {
      font-size: 24px;
      font-weight: bold;
      width: 50px;
      text-align: center;
      color: #adb5bd;
    }
    
    .rank.top-1 { color: #FFD700; }
    .rank.top-2 { color: #C0C0C0; }
    .rank.top-3 { color: #CD7F32; }
    
    .medal {
      font-size: 28px;
    }
    
    .volunteer-info {
      flex: 1;
      margin-left: 16px;
    }
    
    .volunteer-name {
      font-size: 18px;
      font-weight: 600;
      color: #212529;
      margin-bottom: 4px;
    }
    
    .volunteer-location {
      font-size: 14px;
      color: #6c757d;
    }
    
    .amount {
      font-size: 24px;
      font-weight: bold;
      color: #667eea;
      margin-right: 8px;
    }
    
    .donation-count {
      font-size: 14px;
      color: #6c757d;
      text-align: right;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #6c757d;
    }
    
    .error {
      text-align: center;
      padding: 40px;
      color: #dc3545;
    }
    
    .last-updated {
      text-align: center;
      padding: 16px;
      font-size: 12px;
      color: #adb5bd;
      border-top: 1px solid #e9ecef;
    }
    
    @media (max-width: 600px) {
      .header h1 {
        font-size: 24px;
      }
      
      .volunteer-name {
        font-size: 16px;
      }
      
      .amount {
        font-size: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="leaderboard-container">
    <div class="header">
      <h1>üèÜ MVM Fundraising Champions</h1>
      <p>Live volunteer leaderboard</p>
    </div>
    
    <div class="stats-bar">
      <div class="stat">
        <div class="stat-value" id="totalRaised">¬£0.00</div>
        <div class="stat-label">Total Raised</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="totalDonations">0</div>
        <div class="stat-label">Donations</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="activeVolunteers">0</div>
        <div class="stat-label">Active Volunteers</div>
      </div>
    </div>
    
    <div class="leaderboard" id="leaderboard">
      <div class="loading">Loading leaderboard...</div>
    </div>
    
    <div class="last-updated" id="lastUpdated">
      Last updated: Never
    </div>
  </div>

  <script>
    const SHEET_ID = '1kd2mKHe-Cca3sNi5q1RyUsTYNIAhu_KIJTxhdpqf1OA';
    const SHEET_NAME = 'Donations';
    
    async function fetchLeaderboardData() {
      try {
        const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${SHEET_NAME}`;
        
        console.log('Fetching from:', url);
        
        const response = await fetch(url);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const text = await response.text();
        console.log('Raw response:', text.substring(0, 200));
        
        // Google returns JSONP, need to extract JSON
        const jsonString = text.match(/google\.visualization\.Query\.setResponse\((.*)\);/)?.[1];
        
        if (!jsonString) {
          throw new Error('Could not parse response - make sure sheet is public');
        }
        
        const json = JSON.parse(jsonString);
        
        console.log('Parsed data:', json);
        
        if (json.status === 'error') {
          throw new Error(json.errors[0].detailed_message || 'Unknown error from Google Sheets');
        }
        
        const rows = json.table.rows;
        
        if (!rows || rows.length === 0) {
          console.log('No data rows found');
          return [];
        }
        
        console.log('Processing', rows.length, 'rows');
        
        // Process data: aggregate by volunteer_id
        const volunteerMap = {};
        
        rows.forEach((row, index) => {
          const cells = row.c;
          if (!cells || cells.length < 3) {
            console.log('Skipping row', index, '- not enough cells');
            return;
          }
          
          const volunteerId = cells[1]?.v; // Column B: Volunteer ID
          const amount = parseFloat(cells[2]?.v || 0); // Column C: Amount
          
          console.log('Row', index, ':', volunteerId, amount);
          
          if (!volunteerId || volunteerId === 'unknown') return;
          
          if (!volunteerMap[volunteerId]) {
            volunteerMap[volunteerId] = {
              id: volunteerId,
              total: 0,
              count: 0
            };
          }
          
          volunteerMap[volunteerId].total += amount;
          volunteerMap[volunteerId].count += 1;
        });
        
        // Convert to array and sort by total
        const leaderboard = Object.values(volunteerMap)
          .sort((a, b) => b.total - a.total);
        
        console.log('Final leaderboard:', leaderboard);
        
        return leaderboard;
        
      } catch (error) {
        console.error('Error fetching data:', error);
        document.getElementById('leaderboard').innerHTML = 
          `<div class="error">Error loading data: ${error.message}<br><br>
          Check console for details (F12)</div>`;
        return [];
      }
    }
    
    function parseVolunteerId(volunteerId) {
      // Convert "reuben_stafford" to "Reuben from Stafford"
      const parts = volunteerId.split('_');
      if (parts.length < 2) {
        return {
          name: volunteerId,
          location: 'Unknown'
        };
      }
      
      const name = parts[0].charAt(0).toUpperCase() + parts[0].slice(1);
      const location = parts[1].charAt(0).toUpperCase() + parts[1].slice(1);
      
      return { name, location };
    }
    
    function getMedalEmoji(rank) {
      switch(rank) {
        case 1: return 'ü•á';
        case 2: return 'ü•à';
        case 3: return 'ü•â';
        default: return '';
      }
    }
    
    function renderLeaderboard(data) {
      const container = document.getElementById('leaderboard');
      
      if (data.length === 0) {
        container.innerHTML = '<div class="loading">No donations yet. Be the first!</div>';
        return;
      }
      
      // Update stats
      const totalRaised = data.reduce((sum, v) => sum + v.total, 0);
      const totalDonations = data.reduce((sum, v) => sum + v.count, 0);
      
      document.getElementById('totalRaised').textContent = `¬£${totalRaised.toFixed(2)}`;
      document.getElementById('totalDonations').textContent = totalDonations;
      document.getElementById('activeVolunteers').textContent = data.length;
      
      // Render leaderboard items
      container.innerHTML = data.map((volunteer, index) => {
        const rank = index + 1;
        const { name, location } = parseVolunteerId(volunteer.id);
        const medal = getMedalEmoji(rank);
        const rankClass = rank <= 3 ? `top-${rank}` : '';
        
        return `
          <div class="leaderboard-item">
            <div class="rank ${rankClass}">
              ${medal ? `<span class="medal">${medal}</span>` : rank}
            </div>
            <div class="volunteer-info">
              <div class="volunteer-name">${name}</div>
              <div class="volunteer-location">from ${location}</div>
            </div>
            <div>
              <div class="amount">¬£${volunteer.total.toFixed(2)}</div>
              <div class="donation-count">${volunteer.count} donation${volunteer.count !== 1 ? 's' : ''}</div>
            </div>
          </div>
        `;
      }).join('');
      
      // Update timestamp
      const now = new Date();
      document.getElementById('lastUpdated').textContent = 
        `Last updated: ${now.toLocaleTimeString()}`;
    }
    
    async function updateLeaderboard() {
      const data = await fetchLeaderboardData();
      renderLeaderboard(data);
    }
    
    // Initial load
    updateLeaderboard();
    
    // Auto-refresh every 15 seconds
    setInterval(updateLeaderboard, 15000);
  </script>
</body>
</html>